<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Example-SMART-App</title>
  </head>
  <body>
    <p>Health!</p>
    <input type="button" value="Cerner Login" id="cernerLogin" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript">
      var width = 780,
      height = 550,
      left = (screen.width - width) / 2,
      top = (screen.height - height) / 2,
      uniqueWindowId = "authorization-" + "ed483332-dc6e-4683-bf28-f113492c00b7",
      params,
      location,
      tokenUrl,
      authorizeUrl;
      if (top > 20) {
        top = top - 20;
      }
      params = 'width=' + width + ', height=' + height;
      params += ', top=' + top + ', left=' + left;
      params += 'titlebar=no, location=yes';
      document.getElementById("cernerLogin").addEventListener("click", function () {
         loginWindow = window.open(authorizeUrl + "?client_id=ed483332-dc6e-4683-bf28-f113492c00b7&response_type=code&redirect_uri=&scope=user%2FPatient.read%20user%2FObservation.read%20&launch=&aud=https%3A%2F%2Ffhir-ehr.sandboxcerner.com%2Fdstu2%2F0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca%2F&state=a4c16a46-2c46-482c-8d66-4cc4a2990bda", uniqueWindowId, params);  
      }, 'false');
      $.ajax({
          url: 'https://fhir-ehr.sandboxcerner.com/dstu2/0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca/metadata',
          type: 'get',
          headers: {
              Accept: 'application/json'
          },
          success: function (data) {
              console.info(data);
              var urls = data.rest && data.rest[0].security.extension[0].extension;
              tokenUrl = urls[0].valueUri;
              authorizeUrl = urls[1].valueUri;
          }
      });
      window.addEventListener("message", function (e) {
        var oauthMessage = e.data;
        processOAuthMessage(oauthMessage);
      }, false);
      function authDetails(details) {
        console.log(details.href);
        var url = details.href;
        loginWindow.close();
        $.ajax({
          url: tokenUrl,
          type: 'post',
          data: {
              'grant_type': 'authorization_code',
              'code': url.split('code=')[1].split('&state')[0],
              'client_id': 'ed483332-dc6e-4683-bf28-f113492c00b7',   
              'state': 'a4c16a46-2c46-482c-8d66-4cc4a2990bda'
          },
          headers: {
              accept: 'application/json'
          },
          success: function (data) {
              console.info(data);
              $.ajax({
                url: 'https://fhir-ehr.sandboxcerner.com/dstu2/0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca/Patient/4342008',
                type: 'get',
                headers: {
                    Accept: 'application/json+fhir',
                    Authorization: 'Bearer ' + data["access_token"]
                },
                success: function (data) {
                    console.info(data);
                    //window.location = "https://sundarbalaji93.github.io/smart-on-fhir-tutorial/example-smart-app/home.html";
                }
              });
            }
        });
      }
    </script>
  </body>
</html>
