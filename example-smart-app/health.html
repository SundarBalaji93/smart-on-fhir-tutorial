<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Example-SMART-App</title>
  </head>
  <body>
    <img src="./src/images/batman.gif" alt="Batman">
    <p>Health!</p>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript">
      var width = 780,
      height = 550,
      left = (screen.width - width) / 2,
      top = (screen.height - height) / 2,
      uniqueWindowId = "authorization-" + "ed483332-dc6e-4683-bf28-f113492c00b7",
      params,
      location;
      if (top > 20) {
        top = top - 20;
      }
      params = 'width=' + width + ', height=' + height;
      params += ', top=' + top + ', left=' + left;
      params += 'titlebar=no, location=yes';
      loginWindow = window.open("https://authorization.sandboxcerner.com/tenants/0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca/protocols/oauth2/profiles/smart-v1/personas/provider/authorize?client_id=ed483332-dc6e-4683-bf28-f113492c00b7&response_type=code&redirect_uri=&scope=user%2FPatient.read%20user%2FObservation.read%20&launch=&aud=https%3A%2F%2Ffhir-ehr.sandboxcerner.com%2Fdstu2%2F0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca%2F&state=a4c16a46-2c46-482c-8d66-4cc4a2990bda", uniqueWindowId, params);
      window.addEventListener("message", function (e) {
        var oauthMessage = e.data;
        processOAuthMessage(oauthMessage);
      }, false);
      function authDetails(details) {
        console.log(details.href);
        var url = details.href;
        loginWindow.close();
        $.ajax({
          url: 'https://authorization.sandboxcerner.com/tenants/0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca/protocols/oauth2/profiles/smart-v1/token',
          type: 'post',
          data: {
              'grant_type': 'authorization_code',
              'code': url.split('code=')[1].split('&state')[0],
              'client_id': 'ed483332-dc6e-4683-bf28-f113492c00b7',   
              'state': 'a4c16a46-2c46-482c-8d66-4cc4a2990bda'
          },
          headers: {
              accept: 'application/json'
          },
          success: function (data) {
              console.info(data);
              $.ajax({
                url: 'https://fhir-ehr.sandboxcerner.com/dstu2/0b8a0111-e8e6-4c26-a91c-5069cbc6b1ca/Patient/4342008',
                type: 'get',
                headers: {
                    accept: 'application/json+fhir',
                    authorization: data["access_token"]
                },
                success: function (data) {
                    console.info(data);
                }
              });
            }
          });
      }
    </script>
  </body>
</html>
